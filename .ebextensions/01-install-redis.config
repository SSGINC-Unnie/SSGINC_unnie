# .ebextensions/01-redis.config

packages:
  yum:
    redis: []   # amazon linux 2에서 yum으로 설치 가능 (없으면 amazon-linux-extras enable 필요)

commands:
  01_detect_conf_path:
    command: |
      bash -lc '
      # Redis 설정 파일 경로(배포 이미지마다 다를 수 있어 두 경로 모두 점검)
      if [ -f /etc/redis/redis.conf ]; then
        echo "/etc/redis/redis.conf" > /tmp/redis_conf_path
      elif [ -f /etc/redis.conf ]; then
        echo "/etc/redis.conf" > /tmp/redis_conf_path
      else
        # 기본 경로로 생성
        mkdir -p /etc/redis
        echo "/etc/redis/redis.conf" > /tmp/redis_conf_path
        if [ ! -f /etc/redis/redis.conf ]; then
          cp /etc/redis.conf /etc/redis/redis.conf 2>/dev/null || true
        fi
      fi
      '

  02_redis_configure_bind_and_protectedmode:
    command: |
      bash -lc '
      CONF=$(cat /tmp/redis_conf_path)
      # 바인드/프로텍티드 모드 설정 (원격 접속 필요 없으면 bind 유지해도 무방)
      sed -i "s/^\s*bind 127\.0\.0\.1/# bind 127.0.0.1/g" "$CONF" || true
      sed -i "s/^\s*protected-mode yes/protected-mode no/g" "$CONF" || true

      # 필요시 포그라운드/백그라운드 설정 보정
      if grep -qE "^\s*daemonize" "$CONF"; then
        sed -i "s/^\s*daemonize.*/daemonize yes/g" "$CONF"
      else
        echo "daemonize yes" >> "$CONF"
      fi
      '

  03_enable_and_start_redis:
    command: |
      bash -lc '
      systemctl daemon-reload || true
      systemctl enable redis || true
      systemctl restart redis || systemctl start redis
      systemctl status redis --no-pager -l || true
      ss -lntp | grep ":6379" || true
      '

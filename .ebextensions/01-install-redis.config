# .ebextensions/01-redis.config

packages:
  yum:
    redis: []

commands:
  01_detect_conf_path:
    command: |
      bash -lc '
      if [ -f /etc/redis/redis.conf ]; then
        echo "/etc/redis/redis.conf" > /tmp/redis_conf_path
      elif [ -f /etc/redis.conf ]; then
        echo "/etc/redis.conf" > /tmp/redis_conf_path
      else
        mkdir -p /etc/redis
        echo "/etc/redis/redis.conf" > /tmp/redis_conf_path
        if [ ! -f /etc/redis/redis.conf ]; then
          cp /etc/redis.conf /etc/redis/redis.conf 2>/dev/null || true
        fi
      fi
      '

  02_redis_configure_bind_and_protectedmode:
    command: |
      bash -lc '
      CONF=$(cat /tmp/redis_conf_path)
      sed -i "s/^\s*bind 127\.0\.0\.1/# bind 127.0.0.1/g" "$CONF" || true
      sed -i "s/^\s*protected-mode yes/protected-mode no/g" "$CONF" || true

      if grep -qE "^\s*daemonize" "$CONF"; then
        sed -i "s/^\s*daemonize.*/daemonize yes/g" "$CONF"
      else
        echo "daemonize yes" >> "$CONF"
      fi
      '

  03_enable_and_start_redis:
    command: |
      bash -lc '
      systemctl daemon-reload || true
      systemctl enable redis || true
      systemctl restart redis || systemctl start redis
      systemctl status redis --no-pager -l || true
      ss -lntp | grep ":6379" || true
      '

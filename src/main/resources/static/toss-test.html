<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>토스 결제 위젯 테스트 (최종)</title>

    <script src="https://js.tosspayments.com/payment-widget"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; max-width: 720px; margin: 40px auto; padding: 0 20px; background-color: #f8f9fa; }
        .container { background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .input-group { display: flex; flex-direction: column; }
        .input-group label { margin-bottom: 8px; font-weight: 600; color: #495057; }
        .input-group input { padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 16px; }
        .button-group { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        button { padding: 12px; border: none; border-radius: 6px; background-color: #007bff; color: white; font-size: 16px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #e9ecef; color: #6c757d; cursor: not-allowed; }
        #pay-button { background-color: #28a745; display: none; }
        #pay-button:hover { background-color: #218838; }
        h2 { text-align: center; color: #343a40; }
        #payment-widget, #agreement { margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h2>토스 결제 테스트</h2>
    <div class="input-group">
        <label for="reservationId">예약 ID</label>
        <input id="reservationId" value="1">
    </div>

    <div class="button-group">
        <button id="start-button">1. 결제 정보 생성 및 위젯 렌더링</button>
    </div>

    <div id="payment-widget"></div>
    <div id="agreement"></div>

    <div class="button-group">
        <button id="pay-button" disabled>2. 결제 요청</button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const startButton = document.getElementById('start-button');
        const payButton = document.getElementById('pay-button');
        const reservationIdInput = document.getElementById('reservationId');

        const sessionApiUrl = "/api/payments/toss/widget-session";

        let paymentWidget; // '결제 위젯' 객체를 저장할 변수
        let paymentData;

        startButton.addEventListener('click', async () => {
            try {
                const reservationId = Number(reservationIdInput.value);
                const orderId = `UNNIE-ORDER-${reservationId}-${Date.now()}`;

                const response = await fetch(sessionApiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ reservationId, memberId: 1, shopId: 1, orderId })
                });

                if (!response.ok) throw new Error("주문 정보 생성 실패");

                const responseData = await response.json();
                paymentData = responseData.data;
                console.log("백엔드 수신 데이터:", paymentData);

                // ✅ 3. 'PaymentWidget' 생성자를 사용합니다.
                const customerKey = `test_customer_${reservationId}`;
                paymentWidget = PaymentWidget(paymentData.clientKey, customerKey);

                // ✅ 4. 위젯 렌더링 함수들을 호출합니다.
                paymentWidget.renderPaymentMethods("#payment-widget", { value: paymentData.amount });
                paymentWidget.renderAgreement("#agreement");

                payButton.style.display = 'block';
                payButton.disabled = false;

            } catch (error) {
                alert(error.message || "오류 발생");
            }
        });

        payButton.addEventListener('click', async () => {
            if (!paymentWidget || !paymentData) {
                alert("결제 정보가 생성되지 않았습니다.");
                return;
            }
            try {
                // ✅ 5. 위젯 객체의 requestPayment 함수를 호출합니다.
                await paymentWidget.requestPayment({
                    orderId: paymentData.orderId,
                    orderName: paymentData.orderName,
                    successUrl: paymentData.successUrl,
                    failUrl: paymentData.failUrl,
                    customerName: "김토스",
                });
            } catch (error) {
                alert("결제 요청에 실패했습니다.");
            }
        });
    });
</script>
</body>
</html>
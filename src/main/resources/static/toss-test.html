<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>Toss Widget Test</title>
    <script src="https://js.tosspayments.com/v1/payment-widget.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 640px; margin: 40px auto; }
        #agreement, #payment-method { margin: 16px 0; }
        input { padding: 6px 8px; }
        button { padding: 8px 12px; }
    </style>
</head>
<body>
<h2>토스 결제 테스트 (prod)</h2>

<div>
    <label>Reservation ID: <input id="reservationId" value="1"></label>
</div>
<button id="start">세션 생성 & 결제창 렌더</button>

<div id="payment-method"></div>
<div id="agreement"></div>
<button id="pay" style="display:none;">결제하기</button>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        const sessionApi = "/api/payments/toss/widget-session";
        let paymentWidget, orderId, amount, orderName, successUrl, failUrl;

        async function createSession() {
            const reservationId = Number(document.getElementById('reservationId').value);
            const order = "ORD-TEST-" + reservationId + "-" + Date.now();

            const res = await fetch(sessionApi, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    reservationId: reservationId,
                    memberId: 1,
                    shopId: 1,
                    orderId: order
                })
            });

            if (!res.ok) {
                const err = await res.json().catch(()=>({message: res.statusText}));
                alert("세션 생성 실패: " + (err.message || res.statusText));
                return;
            }

            const { data } = await res.json();

            const clientKey = data.clientKey;
            orderId   = data.orderId;
            amount    = data.amount;
            orderName = data.orderName;
            successUrl = data.successUrl;
            failUrl    = data.failUrl;

            if (!window.PaymentWidget) {
                alert("토스 위젯 로드 실패(네트워크 또는 차단 확?).");
                return;
            }

            paymentWidget = PaymentWidget(clientKey, "customer-001");
            paymentWidget.renderPaymentMethods("#payment-method", { value: amount }, { variantKey: "DEFAULT" });
            paymentWidget.renderAgreement("#agreement", { variantKey: "AGREEMENT" });

            document.getElementById('pay').style.display = 'inline-block';
        }

        async function requestPay() {
            await paymentWidget.requestPayment({
                orderId: orderId,
                orderName: orderName,
                successUrl: successUrl,
                failUrl: failUrl,
                customerName: "테스트사용자"
            });
        }

        document.getElementById('start').addEventListener('click', createSession);
        document.getElementById('pay').addEventListener('click', requestPay);
    });
</script>
</body>
</html>

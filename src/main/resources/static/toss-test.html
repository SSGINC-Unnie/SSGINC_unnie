<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- 페이지 한정 CSP (테스트용). 운영에선 unsafe-eval 제거 권장 -->
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self';
               script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.tosspayments.com;
               connect-src 'self' https://api.tosspayments.com https://*.tosspayments.com;
               frame-src https://*.tosspayments.com;
               img-src 'self' data: https:">

    <meta charset="utf-8" />
    <title>Toss Widget Test (prod)</title>

    <script src="https://js.tosspayments.com/v1/payment-widget"></script>
    <style>
        body { font-family: sans-serif; max-width: 640px; margin: 40px auto; }
        #agreement, #payment-method { margin: 16px 0; }
        input { padding: 6px 8px; } button { padding: 8px 12px; }
    </style>
</head>
<body>
<h2>토스 결제 테스트 (prod)</h2>

<div>
    <label>Reservation ID: <input id="reservationId" value="1"></label>
</div>
<button id="start">세션 생성 & 결제창 렌더</button>

<div id="payment-method"></div>
<div id="agreement"></div>
<button id="pay" style="display:none;">결제하기</button>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        const sessionApi = "/api/payments/toss/widget-session";
        let paymentWidget, orderId, amount, orderName, successUrl, failUrl;

        async function createSession() {
            const reservationId = Number(document.getElementById('reservationId').value);
            const order = "ORD-TEST-" + reservationId + "-" + Date.now();

            const res = await fetch(sessionApi, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ reservationId, memberId: 1, shopId: 1, orderId: order })
            });

            if (!res.ok) {
                const err = await res.json().catch(() => ({ message: res.statusText }));
                alert("세션 생성 실패: " + (err.message || res.statusText));
                return;
            }

            const { data } = await res.json();
            const clientKey = data.clientKey;
            orderId   = data.orderId;
            amount    = data.amount;
            orderName = data.orderName;
            successUrl = data.successUrl;
            failUrl    = data.failUrl;

            console.log('widget session data:', data);
            console.log('clientKey prefix/len:', data?.clientKey?.slice(0, 7), data?.clientKey?.length);

            if (!window.PaymentWidget) {
                alert("토스 위젯 로드 실패(네트워크/차단 확인).");
                return;
            }

            paymentWidget = PaymentWidget(clientKey, "customer-001");
            paymentWidget.renderPaymentMethods("#payment-method", { value: amount }, { variantKey: "DEFAULT" });
            paymentWidget.renderAgreement("#agreement", { variantKey: "AGREEMENT" });
            document.getElementById('pay').style.display = 'inline-block';
        }

        async function requestPay() {
            await paymentWidget.requestPayment({
                orderId, orderName, successUrl, failUrl, customerName: "테스트사용자"
            });
        }

        document.getElementById('start').addEventListener('click', createSession);
        document.getElementById('pay').addEventListener('click', requestPay);
    });
</script>
</body>
</html>
